## SQL 튜닝

### 튜닝 전 SQL 문

```sql
SELECT *
FROM 사원
WHERE SUBSTRING(사원번호, 1, 4) = 1100
AND LENGTH(사원번호) = 5
```

SUBSTRING()은 해당 컬럼에서 1 인덱스에서 4글자까지 1100이고, 사원번호의 길이가 5인 데이터를 가져오는 쿼리문이다.

SUBSTRING() 함수에 의해 테이블 풀 스캔이 이뤄진다.

### 튜닝 후 SQL 문

```sql
SELECT *
FROM 사원
WHERE 사원번호 BETWEEN 11000 AND 11009
```
사원번호는 기본키이고 BETWEEN 구문에 의해 기본 키의 특정 범위만 스캔한다.

### 튜닝 전 SQL 문

```sql
EXPLAIN SELECT COUNT(1) FROM 급여 WHERE 사용여부 = 1;

+----+-------------+-------+------------+-------+---------------+------------+---------+------+---------+----------+--------------------------+
| id | select_type | table | partitions | type  | possible_keys | key        | key_len | ref  | rows    | filtered | Extra                    |
+----+-------------+-------+------------+-------+---------------+------------+---------+------+---------+----------+--------------------------+
|  1 | SIMPLE      | 급여  | NULL       | index | I_사용여부    | I_사용여부 | 4       | NULL | 2838384 |    10.00 | Using where; Using index |
+----+-------------+-------+------------+-------+---------------+------------+---------+------+---------+----------+--------------------------+
```

type을 확인하면 index 풀 스캔이 사용되었다는 것을 알 수 있다.

또한 filtered를 확인하면 전체 조회한 데이터 중 10%만 사용해서 현재 데이터를 조회 했다는 것을 알 수 있다.

이것은 WHERE EQ 조건문이지만 인덱스를 제대로 활용하지 못하고 인덱스 풀 스캔이 진행 되었다는 것을 알 수 있다.

그 이유는 아래 데이터 타입을 조회하면 알 수 있듯이 묵시적 형변환이 이뤄졌기 때문이다.

```sql
desc 급여;
+----------+---------+------+-----+---------+-------+
| Field    | Type    | Null | Key | Default | Extra |
+----------+---------+------+-----+---------+-------+
| 사원번호 | int     | NO   | PRI | NULL    |       |
| 연봉     | int     | NO   |     | NULL    |       |
| 시작일자 | date    | NO   | PRI | NULL    |       |
| 종료일자 | date    | NO   |     | NULL    |       |
| 사용여부 | char(1) | YES  | MUL |         |       |
+----------+---------+------+-----+---------+-------+
```

튜닝된 쿼리문을 비교해보면 더 명확하게 이해할 수 있다.

### 튜닝 후 SQL 문

```sql
EXPLAIN SELECT COUNT(1) FROM 급여 WHERE 사용여부 = '1';
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
|  1 | SIMPLE      | 급여  | NULL       | ref  | I_사용여부    | I_사용여부 | 4       | const | 82824 |   100.00 | Using index |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
```

이렇게 데이터 유형에 맞게 열을 활용해야 내부적인 형변환이 발생하지 않는다!

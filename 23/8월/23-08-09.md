## JPA

### 변경 감지와 병합

준영속 엔티티란 영속성 컨텍스트가 더 이상 관리하지 않는 엔티티를 의미한다. 이때 임의로 만들어낸 엔티티라도 DB에 저장된 식별자가 있다면 준영속 엔티티로 볼 수 있다.

준영속 엔티티를 수정하는 방법은 2가지가 있다.
1. 변경 감지 기능 사용
2. 병합(merge) 사용

결론부터 말하자면 변경 감지 기능을 사용해야 한다.

변경 감지 기능은 영속성 컨텍스트에서 엔티티를 조회한 후 데이터를 수정하는 방법이다. 

```java
@Transactional
void update(Item itemParam) { //itemParam: 파리미터로 넘어온 준영속 상태의 엔티티
 Item findItem = em.find(Item.class, itemParam.getId()); //같은 엔티티를 조회한
다.
 findItem.setPrice(itemParam.getPrice()); //데이터를 수정한다.
}
```

병합 시 동작방식을 간단히 설명하면 아래와 같다.

1. 준영속 엔티티의 식별자를 통해 영속 엔티티를 조회
2. 영속 엔티티의 값을 준영속 엔티티의 값으로 **모두 변경**
3. 트랜잭션 커밋 시점에 변경을 감지하고 DB로 UPDATE SQL 실행

여기서 엔티티의 값이 모두 변경되는게 문제점이다.

만약 병합 시점에 엔티티의 값이 없다면 null로 업데이트 되기 때문이다.

### API 설계

요청 값(@RequestBody로)을 엔티티로 받을 때 여러가지 문제점이 발생한다.
1. 엔티티에 View를 위한 로직이 들어갈 수 있다.
2. 하나의 엔티티에 여러 API가 만들어질 수 있는데, 한 엔티티에 각각의 API를 위한 요청 사항을 전부 담기 어렵다.
3. 엔티티가 변경되면 API 스펙이 변한다.

따라서 API 스펙에 맞추어 별도의 DTO를 파라미터로 받는 방식으로 접근해야 한다.


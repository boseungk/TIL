## JDBC

### JDBC 커넥션 인터페이스와 구현
![JDBC 커넥션 인터페이스와 구현](https://github.com/boseungk/TIL/assets/95980754/0e36b903-b465-4743-8da7-e9ff6fb3361e)

JDBC는 일관성을 위해 `java.sql.Connection` 표준 커넥션 인터페이스를 정의하고 데이터베이스 드라이버는 JDBC Connection 인터페이스를 구현한
`org.h2.jdbc.JdbcConnection` 구현체를 제공한다(H2 데이터베이스).

### DriverManager 커넥션 요청 흐름

![커넥션 요청 흐름](https://github.com/boseungk/TIL/assets/95980754/d63ca205-79a7-4505-8e93-7d9ecdbec6a6)

JDBC가 제공하는 DriverManager는 라이브러리에 등록된 DB 드라이버들을 관리하고, 커넥션을
획득하는 기능을 제공한다.

커넥션 요청 흐름은 다음과 같다. 

1. 커넥션이 필요하면 `DriverManager.getConnection()` 을 호출한다.
2. DriverManager는 라이브러리에 등록된 드라이버 목록을 자동으로 인식한다.(여기서는 H2) 그리고 이 드라이버들에게 순서대로 URL, 이름, 비밀번호 등의 접속에 필요한 정보를 넘겨서 커넥션을 획득할 수 있는지 확인한다.
3. 이렇게 찾은 커넥션 구현체가 클라이언트에 반환된다.

### 간단 예제

```java
@Slf4j
public class MemberRepositoryV0 {
    public Member save(Member member) throws SQLException {
        String sql = "insert into member(member_id, money) values(?, ?)";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            //sql Injection 공격 예방
            pstmt.setString(1, member.getMemberId()); 
            pstmt.setInt(2, member.getMoney());
            //sql문에 value 바인딩
            pstmt.executeUpdate();
            return member;
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
            // 작업이 끝난 후 꼭 리소스 정리를 위해 close()
        }

    }

    private void close(Connection con, Statement stmt, ResultSet rs) {
        if (rs != null){
            try {
                rs.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }
        if (stmt != null){
            try {
                stmt.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }
        if (con != null){
            try {
                con.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }
    }

    private Connection getConnection(){
        return DBConnectionUtil.getConnection();
    }
}
```